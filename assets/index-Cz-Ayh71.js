(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerPolicy&&(a.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?a.credentials="include":e.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(e){if(e.ep)return;e.ep=!0;const a=n(e);fetch(e.href,a)}})();let w=0;class l{static nextSerial(){return++w}info(o,n){const i=l.nextSerial(),e=new Date().toISOString();console.info(`[${i}] [INFO] ${e} - ${o}`,n||"")}warn(o,n){const i=l.nextSerial(),e=new Date().toISOString();console.warn(`[${i}] [WARN] ${e} - ${o}`,n||"")}error(o,n){const i=l.nextSerial(),e=new Date().toISOString();console.error(`[${i}] [ERROR] ${e} - ${o}`,n||"")}}const r=new l;async function R(){r.info("requesting display media");try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0});return r.info("obtained display media",{tracks:t.getTracks().length}),t}catch(t){throw r.error("failed to obtain display media",{error:t}),t}}async function S(){r.info("requesting user audio");try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});return r.info("obtained user audio",{tracks:t.getAudioTracks().length}),t}catch(t){throw r.error("failed to obtain user audio",{error:t}),t}}function k(t){if(t.length===0)throw new Error("no streams to mix");const o=new AudioContext,n=o.createMediaStreamDestination();t.forEach((a,s)=>{a.getAudioTracks().forEach(y=>{try{const f=new MediaStream([y]);o.createMediaStreamSource(f).connect(n)}catch(f){r.error("failed to create MediaStreamSource",{error:f,idx:s})}})});const i=new MediaStream,e=t[0].getVideoTracks();return e.length===0?r.warn("no video tracks found on first stream when mixing",{streamIndex:0,totalStreams:t.length}):e.forEach(a=>i.addTrack(a)),n.stream.getAudioTracks().forEach(a=>i.addTrack(a)),r.info("mixed streams",{videoTracks:i.getVideoTracks().length,audioTracks:i.getAudioTracks().length}),i}const d={Idle:"idle",Recording:"recording",Paused:"paused",Stopped:"stopped"};class v{mediaRecorder;chunks=[];_state=d.Idle;get state(){return this._state}constructor(o,n){r.info("creating Recorder",{stream:o});const i={};n&&(i.mimeType=n),this.mediaRecorder=new MediaRecorder(o,i),this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.chunks.push(e.data)},this.mediaRecorder.onstart=()=>{this._state=d.Recording,r.info("mediaRecorder started")},this.mediaRecorder.onpause=()=>{this._state=d.Paused,r.info("mediaRecorder paused")},this.mediaRecorder.onresume=()=>{this._state=d.Recording,r.info("mediaRecorder resumed")},this.mediaRecorder.onstop=()=>{this._state=d.Stopped,r.info("mediaRecorder stopped")},this.mediaRecorder.onerror=e=>{r.error("mediaRecorder error",{event:e})}}start(){if(r.info("recorder.start()"),this.mediaRecorder.state!=="inactive"){r.info("recorder.start() called while MediaRecorder is not inactive",{state:this.mediaRecorder.state});return}this.mediaRecorder.start()}pause(){this.mediaRecorder.state==="recording"&&(r.info("recorder.pause()"),this.mediaRecorder.pause())}resume(){this.mediaRecorder.state==="paused"&&(r.info("recorder.resume()"),this.mediaRecorder.resume())}stop(){return r.info("recorder.stop()"),new Promise(o=>{this.mediaRecorder.onstop=()=>{this._state=d.Stopped,r.info("mediaRecorder stopped (stop promise)");const n=new Blob(this.chunks,{type:this.mediaRecorder.mimeType});o(n)},this.mediaRecorder.stop()})}}const E=document.querySelector("#app");E.innerHTML=`
  <header>
    <h1>web-stream-captor プロトタイプ</h1>
  </header>
  <main>
    <section>
      <button id="btn-capture" type="button">画面選択</button>
      <button id="btn-start" type="button" disabled>録画開始</button>
      <button id="btn-stop" type="button" disabled>停止</button>
    </section>
    <section>
      <video id="preview" autoplay muted playsinline style="max-width:100%;"></video>
    </section>
    <section id="downloads"></section>
  </main>
`;const m=document.getElementById("btn-capture"),p=document.getElementById("btn-start"),b=document.getElementById("btn-stop"),g=document.getElementById("preview"),h=document.getElementById("downloads");let c=null,u=null;m.addEventListener("click",async()=>{r.info("click capture button");try{const t=await R();let o=null;try{o=await S()}catch(n){r.error("could not get microphone",{error:n}),alert("マイク音声を取得できませんでした。画面共有のみ録画されます。")}o?(c=k([t,o]),c._orig=[t,o]):(c=t,c._orig=[t]),r.info("currentStream tracks",{video:c.getVideoTracks().length,audio:c.getAudioTracks().length}),g.srcObject=c,g.muted=!0,p.disabled=!1,m.disabled=!0}catch(t){r.error("capture failed",{error:t}),m.disabled=!1,p.disabled=!0}});p.addEventListener("click",()=>{c&&(r.info("click start button"),u=new v(c),u.start(),p.disabled=!0,b.disabled=!1)});b.addEventListener("click",async()=>{if(!u)return;r.info("click stop button");const t=await u.stop(),o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download=`capture-${Date.now()}.webm`,n.textContent="ダウンロード",h.appendChild(n);try{const i=await u.stop(),e=URL.createObjectURL(i),a=document.createElement("a");a.href=e,a.download=`capture-${Date.now()}.webm`,a.textContent="ダウンロード",h.appendChild(a);const s=document.createElement("video");s.controls=!0,s.src=e,s.style.display="block",s.style.maxWidth="100%",h.appendChild(s)}catch(i){console.error("Failed to stop recorder",i)}finally{const i=c?._orig;i?i.forEach(e=>e.getTracks().forEach(a=>a.stop())):c?.getTracks().forEach(e=>e.stop()),g.srcObject=null,b.disabled=!0,m.disabled=!1}});
