(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function a(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(e){if(e.ep)return;e.ep=!0;const n=a(e);fetch(e.href,n)}})();let y=0;class l{static nextSerial(){return++y}info(o,a){const i=l.nextSerial(),e=new Date().toISOString();console.info(`[${i}] [INFO] ${e} - ${o}`,a||"")}warn(o,a){const i=l.nextSerial(),e=new Date().toISOString();console.warn(`[${i}] [WARN] ${e} - ${o}`,a||"")}error(o,a){const i=l.nextSerial(),e=new Date().toISOString();console.error(`[${i}] [ERROR] ${e} - ${o}`,a||"")}}const t=new l;async function R(){t.info("requesting display media");try{const r=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0});return t.info("obtained display media",{tracks:r.getTracks().length}),r}catch(r){throw t.error("failed to obtain display media",{error:r}),r}}async function w(){t.info("requesting user audio");try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});return t.info("obtained user audio",{tracks:r.getAudioTracks().length}),r}catch(r){throw t.error("failed to obtain user audio",{error:r}),r}}function S(r){if(r.length===0)throw new Error("no streams to mix");const o=new AudioContext({sampleRate:48e3}),a=o.createMediaStreamDestination();r.forEach((e,n)=>{try{const s=o.createMediaStreamSource(e),g=o.createGain();g.gain.value=1,s.connect(g).connect(a),t.info("connected stream to audio context",{idx:n,tracks:e.getAudioTracks().length})}catch(s){t.error("failed to process stream in audio context",{idx:n,error:s})}});const i=new MediaStream;return r[0].getVideoTracks().forEach(e=>i.addTrack(e)),a.stream.getAudioTracks().forEach(e=>i.addTrack(e)),t.info("mixed streams with audio context",{videoTracks:i.getVideoTracks().length,audioTracks:i.getAudioTracks().length}),i}const d={Idle:"idle",Recording:"recording",Paused:"paused",Stopped:"stopped"};class k{mediaRecorder;chunks=[];_state=d.Idle;get state(){return this._state}constructor(o,a){t.info("creating Recorder",{stream:o});const i={};a&&(i.mimeType=a),this.mediaRecorder=new MediaRecorder(o,i),this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.chunks.push(e.data)},this.mediaRecorder.onstart=()=>{this._state=d.Recording,t.info("mediaRecorder started")},this.mediaRecorder.onpause=()=>{this._state=d.Paused,t.info("mediaRecorder paused")},this.mediaRecorder.onresume=()=>{this._state=d.Recording,t.info("mediaRecorder resumed")},this.mediaRecorder.onstop=()=>{this._state=d.Stopped,t.info("mediaRecorder stopped")},this.mediaRecorder.onerror=e=>{t.error("mediaRecorder error",{event:e})}}start(){if(t.info("recorder.start()"),this.mediaRecorder.state!=="inactive"){t.info("recorder.start() called while MediaRecorder is not inactive",{state:this.mediaRecorder.state});return}this.mediaRecorder.start()}pause(){this.mediaRecorder.state==="recording"&&(t.info("recorder.pause()"),this.mediaRecorder.pause())}resume(){this.mediaRecorder.state==="paused"&&(t.info("recorder.resume()"),this.mediaRecorder.resume())}stop(){return t.info("recorder.stop()"),new Promise(o=>{this.mediaRecorder.onstop=()=>{this._state=d.Stopped,t.info("mediaRecorder stopped (stop promise)");const a=new Blob(this.chunks,{type:this.mediaRecorder.mimeType});o(a)},this.mediaRecorder.stop()})}}const v=document.querySelector("#app");v.innerHTML=`
  <header>
    <h1>web-stream-captor プロトタイプ</h1>
  </header>
  <main>
    <section>
      <button id="btn-capture" type="button">画面選択</button>
      <button id="btn-start" type="button" disabled>録画開始</button>
      <button id="btn-stop" type="button" disabled>停止</button>
    </section>
    <section>
      <video id="preview" autoplay muted playsinline style="max-width:100%;"></video>
    </section>
    <section id="downloads"></section>
  </main>
`;const m=document.getElementById("btn-capture"),p=document.getElementById("btn-start"),h=document.getElementById("btn-stop"),b=document.getElementById("preview"),f=document.getElementById("downloads");let c=null,u=null;m.addEventListener("click",async()=>{t.info("click capture button");try{const r=await R();let o=null;try{o=await w()}catch(a){t.error("could not get microphone",{error:a}),alert("マイク音声を取得できませんでした。画面共有のみ録画されます。")}o?(c=S([r,o]),c._orig=[r,o]):(c=r,c._orig=[r]),t.info("currentStream tracks",{video:c.getVideoTracks().length,audio:c.getAudioTracks().length}),b.srcObject=c,b.muted=!0,p.disabled=!1,m.disabled=!0}catch(r){t.error("capture failed",{error:r}),m.disabled=!1,p.disabled=!0}});p.addEventListener("click",()=>{c&&(t.info("click start button"),u=new k(c),u.start(),p.disabled=!0,h.disabled=!1)});h.addEventListener("click",async()=>{if(!u)return;t.info("click stop button");const r=await u.stop(),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download=`capture-${Date.now()}.webm`,a.textContent="ダウンロード",f.appendChild(a);try{const i=await u.stop(),e=URL.createObjectURL(i),n=document.createElement("a");n.href=e,n.download=`capture-${Date.now()}.webm`,n.textContent="ダウンロード",f.appendChild(n);const s=document.createElement("video");s.controls=!0,s.src=e,s.style.display="block",s.style.maxWidth="100%",f.appendChild(s)}catch(i){console.error("Failed to stop recorder",i)}finally{const i=c?._orig;i?i.forEach(e=>e.getTracks().forEach(n=>n.stop())):c?.getTracks().forEach(e=>e.stop()),b.srcObject=null,h.disabled=!0,m.disabled=!1}});
