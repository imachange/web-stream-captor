# Gitleaksï¼šå·®åˆ†/ç¾çŠ¶ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆpush / PRï¼‰ã¨
# å±¥æ­´å…¨ä½“ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆschedule / æ‰‹å‹• fullï¼‰ã®ç°¡æ˜“ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# - PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ãªã„ã€æ¤œå‡ºãŒã‚ã‚Œã°ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹
# - æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰ã§ fastï¼ˆå·®åˆ†/ç¾çŠ¶ï¼‰ã‹ fullï¼ˆå±¥æ­´å…¨ä½“ï¼‰ã‚’é¸æŠå¯èƒ½
#
name: ğŸ›¡ï¸ Security: Gitleaks (fast scan + scheduled/full scan)

on:
  push:
  pull_request:
  schedule:
    # é€±æ¬¡ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆUTC æ—¥æ›œ 03:00ï¼‰â€” å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      scan:
        description: 'å®Ÿè¡Œã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„: fastï¼ˆå·®åˆ†/ç¾çŠ¶ï¼‰ã¾ãŸã¯ fullï¼ˆå±¥æ­´å…¨ä½“ï¼‰'
        required: true
        default: 'fast'

permissions:
  contents: read

concurrency:
  group: gitleaks-scan-${{ github.ref || github.workflow }}
  cancel-in-progress: false

jobs:
  scan:
    name: Fast scan (push / pull_request / manual fast)
    runs-on: ubuntu-latest
    # å®Ÿè¡Œæ¡ä»¶ï¼špush ã¾ãŸã¯ pull_request ã®å ´åˆã«å¸¸ã«å®Ÿè¡Œã€‚
    # æ‰‹å‹•å®Ÿè¡Œã§ã¯ inputs.scan ãŒ 'fast' ã®ã¨ãã«å®Ÿè¡Œã€‚
    if: "contains(['push','pull_request'], github.event_name) || github.event.inputs.scan == 'fast'"
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®Ÿè¡Œé–‹å§‹ã®ãƒ­ã‚°ï¼ˆæ—¥æœ¬èªï¼‰
        run: echo "Gitleaks ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆå·®åˆ†/ç¾çŠ¶ï¼‰ã€‚æ¤œå‡ºãŒã‚ã‚Œã°ã‚¸ãƒ§ãƒ–ã¯å¤±æ•—ã—ã¾ã™ã€‚"

      - name: Gitleaks ã‚’å®Ÿè¡Œï¼ˆæ¤œå‡ºã§ã‚¸ãƒ§ãƒ–å¤±æ•—ï¼‰
        # ã‚·ãƒ³ãƒ—ãƒ«ã« action ã‚’ä½¿ã£ã¦æ¤œå‡ºã‚’è¡Œã†ã€‚è¦‹ã¤ã‹ã‚Œã° exit non-zero ã§å¤±æ•—ã€‚
        uses: zricethezav/gitleaks-action@v1
        with:
          args: detect --source . --verbose --redact

      - name: çµæœãƒ­ã‚°ï¼ˆæ—¥æœ¬èªï¼‰
        if: success()
        run: echo "Gitleaks ã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ¤œå‡ºã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
      - name: çµæœãƒ­ã‚°ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã€æ—¥æœ¬èªï¼‰
        if: failure()
        run: echo "::error::Gitleaks ãŒå•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚æ¤œå‡ºå†…å®¹ã‚’ç¢ºèªã—ã¦å¯¾å¿œã—ã¦ãã ã•ã„ã€‚"

  full-scan:
    name: Full-history scan (schedule / manual full)
    runs-on: ubuntu-latest
    # å®Ÿè¡Œæ¡ä»¶ï¼šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã€ã¾ãŸã¯æ‰‹å‹•ã§ inputs.scan == 'full' ã®ã¨ã
    if: "github.event_name == 'schedule' || github.event.inputs.scan == 'full'"
    steps:
      - name: ãƒ•ãƒ«å±¥æ­´ã‚’å«ã‚ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã®ãƒ­ã‚°ï¼ˆæ—¥æœ¬èªï¼‰
        run: echo "Gitleaks ã«ã‚ˆã‚‹å±¥æ­´å…¨ä½“ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼‰ã€‚æ¤œå‡ºãŒã‚ã£ã¦ã‚‚ã‚¸ãƒ§ãƒ–ã¯ç¶™ç¶šã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã™ã€‚"

      - name: Gitleaks ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆJSON ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ï¼‰
        # ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã§ã¯æ¤œå‡ºãŒã‚ã£ã¦ã‚‚å¾Œç¶šã§ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ä¿å­˜ã™ã‚‹ãŸã‚ continue-on-error ã‚’è¨±å¯
        continue-on-error: true
        uses: zricethezav/gitleaks-action@v1
        with:
          args: detect --source . --verbose --redact --report-format json --report-path gitleaks-report.json

      - name: ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ—¥æœ¬èªï¼‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

      - name: ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ã®ãƒ­ã‚°ï¼ˆæ—¥æœ¬èªï¼‰
        run: |
          if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ]; then
            echo "ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼šæ¤œå‡ºãŒã‚ã‚Šã¾ã—ãŸã€‚è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚"
            echo "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆgitleaks-reportï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          else
            echo "ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼šæ¤œå‡ºã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
          fi